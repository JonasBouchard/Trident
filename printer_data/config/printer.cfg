[include mainsail.cfg]
[include macros.cfg]
[include timelapse.cfg]

[include madmax/toolchanger_macros.cfg]
[include madmax/tool_detection.cfg]
[include madmax/toolchanger.cfg]
[include madmax/homing.cfg]
[include madmax/nudge.cfg]

[include madmax/toolhead_0.cfg]
[include madmax/toolhead_1.cfg]
#[include madmax/toolhead_1_as_primary.cfg]



[virtual_sdcard]
path: /home/jonas/printer_data/gcodes   # Path to the virtual SD card directory
on_error_gcode: CANCEL_PRINT            # G-code to execute on error (defined in CANCEL_PRINT macro)


[gcode_arcs]                            # Arc interpolation resolution, handles G2/G3 commands
resolution: 0.1                         
[force_move]                            # Enable force move feature
enable_force_move: true                 
[exclude_object]                        # Exclude object for cancellation

#####################################################################
#                       Model and Acceleration
#####################################################################

[printer]                             # Printer configuration
kinematics: corexy                    # Printer type: corexy
max_velocity: 600                     # Maximum velocity
max_accel: 30000                      # Maximum acceleration
max_z_velocity: 50                    # Maximum Z-axis velocity
max_z_accel: 1000                     # Maximum Z-axis acceleration
minimum_cruise_ratio: 0.5             # Default 0.5
square_corner_velocity: 30            # Square corner velocity


#####################################################################
#	                        MCU Config                              
#####################################################################

[mcu]                                    # Main MCU configuration
#serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_slipper-if00  # Serial port setting
canbus_uuid: 2b548d5dd9cf                # CAN bus UUID
canbus_interface: can0                   # CAN bus interface

#####################################################################
# 	                            LIS2DW                     
#####################################################################

#[mcu btt_lis2dw]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_45503571288FACD8-if00

#[lis2dw]
#cs_pin: btt_lis2dw:gpio9
#spi_bus: spi1a
#spi_software_sclk_pin: btt_lis2dw:gpio10
#spi_software_mosi_pin: btt_lis2dw:gpio11
#spi_software_miso_pin: btt_lis2dw:gpio8
#axes_map: y,x,-z

#[resonance_tester]
#probe_points: 150, 150, 20
#accel_chip: lis2dw

#####################################################################
#                      Temperature Monitoring                            
#####################################################################

[temperature_sensor M8P]                # BTT-M8P temperature sensor configuration       
sensor_type: temperature_mcu            # Sensor type

[temperature_sensor CM5]                # Raspberry Pi CM5 temperature sensor configuration
sensor_type: temperature_host           # Sensor type

[temperature_sensor Chamber]
sensor_type: Generic 3950
sensor_pin: PB0

#####################################################################
#                              X Axis
#####################################################################

[stepper_x]
step_pin: PE6                         # X-axis motor pulse pin setting
dir_pin: !PE5                         # X-axis motor direction pin setting
enable_pin: !PC14                     # X-axis motor enable pin setting
microsteps: 32                        # Motor microsteps setting
rotation_distance: 40                 # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32)
full_steps_per_rotation: 200          # Number of pulses required for a single motor revolution (1.8 degree motor: 200, 0.9 degree motor: 400)
endstop_pin: ^head0:gpio20            # tmc5160_stepper_x: virtual_endstop #EBBCan:PC14              # Limit switch PIN setting (X-)
position_min: 0                       # X-axis minimum travel - software limit
position_endstop: 300                 # Mechanical reset point coordinates for X-axis
position_max: 300                     # X-axis maximum travel - software limit
homing_speed: 150                     # Homing speed maximum 100
homing_retract_dist: 10 #0            # Setback distance after the first trigger of the homing switch
homing_positive_dir: true             # Direction of homing (generally no change required)

[tmc5160 stepper_x]
cs_pin: PC13                          # Chip select pin
spi_software_sclk_pin: PG8            # SPI clock pin
spi_software_mosi_pin: PG6            # SPI master out slave in pin
spi_software_miso_pin: PG7            # SPI master in slave out pin
driver_TPFD: 0                        # Driver setting
run_current: 2.0                      # Running current
spi_speed: 3500000                    # SPI speed
interpolate: False                    # Interpolation default = True
diag1_pin: ^!PF4                      # Diag pin for sensorless homing
driver_SGT: 2                         # -64 is most sensitive value, 63 is least sensitive


[stepper_x1]
step_pin: PD4                         # X1-axis motor pulse pin setting
dir_pin: !PD3                         # X1-axis motor direction pin setting
enable_pin: !PD6                      # X1-axis motor enable pin setting
microsteps: 32                        # Motor microsteps setting
rotation_distance: 40                 # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32)
full_steps_per_rotation: 200          # Number of pulses required for a single motor revolution (1.8 degree motor: 200, 0.9 degree motor: 400)

[tmc5160 stepper_x1]
cs_pin: PD5                           # Chip select pin
spi_software_sclk_pin: PG8            # SPI clock pin
spi_software_mosi_pin: PG6            # SPI master out slave in pin
spi_software_miso_pin: PG7            # SPI master in slave out pin
driver_TPFD: 0                        # Driver setting
run_current: 2.0                      # Running current
spi_speed: 3500000                    # SPI speed
interpolate: False                    # Interpolation default = True

#####################################################################
#                              Y Axis
#####################################################################

[stepper_y]
step_pin: PC7                         # Y-axis motor pulse pin setting
dir_pin: !PC8                         # Y-axis motor direction pin setting
enable_pin: !PD2                      # Y-axis motor enable pin setting
microsteps: 32                        # Motor microsteps setting
rotation_distance: 40                 # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32)
full_steps_per_rotation: 200          # Number of pulses required for a single motor revolution (1.8 degree motor: 200, 0.9 degree motor: 400)
endstop_pin: PF2                      # Limit switch PIN setting (Y-)
position_min: -1                      # Y-axis minimum travel - software limit
position_endstop: 311.1               # Mechanical reset point coordinates for Y-axis
position_max: 311.1                   # Y-axis maximum travel - software limit
homing_speed: 150                     # Homing speed maximum 100
homing_retract_dist: 0                # Setback distance after the first trigger of the homing switch
homing_positive_dir: true             # Direction of homing (generally no change required)

[tmc5160 stepper_y]
cs_pin: PC6                           # Chip select pin
spi_software_sclk_pin: PG8            # SPI clock pin
spi_software_mosi_pin: PG6            # SPI master out slave in pin
spi_software_miso_pin: PG7            # SPI master in slave out pin
driver_TPFD: 0                        # Driver setting
run_current: 2.0                      # Running current
spi_speed: 3500000                    # SPI speed
interpolate: False                    # Interpolation default = True

[stepper_y1]
step_pin: PE2                         # Y1-axis motor pulse pin setting
dir_pin: !PE1                         # Y1-axis motor direction pin setting
enable_pin: !PE4                      # Y1-axis motor enable pin setting
microsteps: 32                        # Motor microsteps setting
rotation_distance: 40                 # Active pulley circumference mm (2GT-20T pulley 40, 2GT-16T pulley 32)
full_steps_per_rotation: 200          # Number of pulses required for a single motor revolution (1.8 degree motor: 200, 0.9 degree motor: 400)

[tmc5160 stepper_y1]
cs_pin: PE3                           # Chip select pin
spi_software_sclk_pin: PG8            # SPI clock pin
spi_software_mosi_pin: PG6            # SPI master out slave in pin
spi_software_miso_pin: PG7            # SPI master in slave out pin
driver_TPFD: 0                        # Driver setting
run_current: 2.0                      # Running current
spi_speed: 3500000                    # SPI speed
interpolate: False                    # Interpolation default = True

#####################################################################
#                               Z Axis
#####################################################################
#                         -------z1------- 
#                        |                 |
#                        |                 |
#                        |                 |
#                        |                 |
#                        |                 |
#                        |                 |
#                       z0---  display  ---z2
#####################################################################


[stepper_z]
step_pin: PB8                         # Z0-axis motor pulse pin setting
dir_pin: !PB7                         # Z0-axis motor direction pin setting
enable_pin: !PE0                      # Z0-axis motor enable pin setting
microsteps: 16                        # Motor microsteps setting
rotation_distance: 4                  # Active pulley circumference mm
endstop_pin: probe:z_virtual_endstop  # Limit switch PIN setting (Z0-)
position_max: 235                     # Z0-axis maximum travel - software limit
position_min: -5                      # Z0-axis minimum travel - software limit
homing_speed: 15                      # Homing speed
homing_retract_dist: 0                # Setback distance after the first trigger of the homing switch
homing_positive_dir: False            # Direction of homing (generally no change required)

#--------------------------------------------------------------------
[tmc2209 stepper_z]                   # TMC2209 driver settings
uart_pin: PB9                         # Driver communication port
interpolate: true                     # Enable 256 microstep interpolation
run_current: 1.0                      # Motor running current (mA)
hold_current: 1.0                     # Holding current (mA)

#--------------------------------------------------------------------
[stepper_z1]
step_pin: PB4                         # Z1-axis motor pulse pin setting
dir_pin: !PB3                         # Z1-axis motor direction pin setting
enable_pin: !PB6                      # Z1-axis motor enable pin setting
microsteps: 16                        # Motor microsteps setting
rotation_distance: 4                  # Active pulley circumference mm

#--------------------------------------------------------------------
[tmc2209 stepper_z1]                  # TMC2209 driver settings
uart_pin: PB5                         # Driver communication port
interpolate: true                     # Enable 256 microstep interpolation
run_current: 1.0                      # Motor running current (mA)
hold_current: 1.0                     # Holding current (mA)

#--------------------------------------------------------------------
[stepper_z2]
step_pin: PG13                        # Z2-axis motor pulse pin setting
dir_pin: !PG12                        # Z2-axis motor direction pin setting
enable_pin: !PG15                     # Z2-axis motor enable pin setting
microsteps: 16                        # Motor microsteps setting
rotation_distance: 4                  # Active pulley circumference mm

#--------------------------------------------------------------------
[tmc2209 stepper_z2]                  # TMC2209 driver settings
uart_pin: PG14                        # Driver communication port
interpolate: true                     # Enable 256 microstep interpolation
run_current: 1.0                      # Motor running current (mA)
hold_current: 1.0                     # Holding current (mA)

#####################################################################
#                             Heated Bed
#####################################################################

[heater_bed]
heater_pin: PA1                         # (BE0) Heater pin
sensor_pin: PB1                         # Sensor interface (TB) sensor pin
sensor_type: ATC Semitec 104GT-2        # ATC Semitec 104GT-2 temperature sensor type
#control: pid                           # Control method
## Heated bed temperature PID calibration command: "PID_CALIBRATE HEATER=heater_bed TARGET=100"
#pid_kp: 57                             # PID Kp value
#pid_ki: 2                              # PID Ki value
#pid_kd: 500                            # PID Kd value
min_temp: 0                             # Minimum temperature
max_temp: 130                           # Maximum temperature
max_power: 1.0                          # Maximum power

#####################################################################
#                     Idle Timeout for Heated Bed
#####################################################################

[idle_timeout]
timeout: 7200                           # Turn off heated bed if idle for more than 120 minutes
gcode:
  TURN_OFF_HEATERS
  SET_FAN_SPEED FAN=exhaust_fan SPEED=0
  

#####################################################################
#                        Bed Mesh Calibration
#####################################################################

[bed_mesh]
probe_count: 5,5                        # Number of sampling points
speed: 400                              # Calibration speed
horizontal_move_z: 2                    # Z-axis movement speed
mesh_min: 45,25                         # Minimum calibration point coordinates x, y
mesh_max: 255,280                       # Maximum calibration point coordinates x, y
mesh_pps: 2,2                           # Additional sampling points
algorithm: bicubic                      # Algorithm model
bicubic_tension: 0.2                    # Algorithm interpolation, no movement
zero_reference_position: 150,150

#####################################################################
#                               Fans
#####################################################################

[controller_fan skirt_fan]       # Skirt fan 
pin: PF9                         # FAN-2
cycle_time: 0.00003              # Cycle time
max_power: 1.0                   # Maximum power
shutdown_speed: 0.0              # Closing speed (Please do not change)
kick_start_time: 0.5             # start-up time (Please do not change)
fan_speed: 0.5                   # Fan speed
idle_timeout: 0                  # Time in seconds to keep the fan running after the stepper driver or heater is no longer active. Default is 30 seconds.
stepper: stepper_x               # Active motors
heater: 

#--------------------------------------------------------------------

[controller_fan driver_fan]      # Driver cooling fan
pin: PF6                         # Fan pin 
cycle_time: 0.00003              # Cycle time
max_power: 1.0                   # Maximum power
shutdown_speed: 0.0              # Shutdown speed
fan_speed: 1.0                   # Fan speed when heater or stepper driver is active (0.0 to 1.0). Default is 1.0.
idle_timeout: 0                  # Time in seconds to keep the fan running after the stepper driver or heater is no longer active. Default is 30 seconds.
idle_speed: 0.4                  # Fan speed after the stepper driver is no longer active and before idle_timeout is reached (0.0 to 1.0). Default is fan_speed.
stepper: stepper_x               # Active motors
heater:

#--------------------------------------------------------------------

[temperature_fan _cm5_fan]
pin: PA6                         # Fan pin
tachometer_pin: ^PC2             # Tachometer pin (rpm)
max_power: 1.0                   # Maximum power
hardware_pwm: false              # hardware pwm
kick_start_time: 0.5             # start-up time (Please do not change)
min_temp: 0.0
max_temp: 85.0
target_temp: 50.0
sensor_type: temperature_host
control: pid
pid_Kp: 1.0
pid_Ki: 1.0
pid_Kd: 1.0

# Define the name of the heater/stepper configuration section associated with this fan. 
# If a comma-separated list of heater/stepper names is provided here, the fan will be enabled when any of the given heaters/steppers are enabled.
# The default heater is "extruder", and the default stepper is all steppers.

#--------------------------------------------------------------------

[fan_generic auxiliary_fan]      # 12032 Auxiliary Part cooling Blower 
pin: PA0                         # Fan pin
cycle_time: 0.00003              # Cycle time
hardware_pwm: false              # hardware pwm
kick_start_time: 0.5             # start-up time (Please do not change)

#--------------------------------------------------------------------

[fan_generic exhaust_fan]        # Fume_Pack Exhaust Fan
pin: PF7                         # Fan pin     
cycle_time: 0.00003              # Cycle time
hardware_pwm: false              # hardware pwm
kick_start_time: 0.5             # start-up time (Please do not change)

#####################################################################
#                             RGB-Leds
#####################################################################

[neopixel chamber_led]
pin: PD15                     # Signal interface
chain_count: 50               # Number of LEDs
color_order: GRB              # Color order
initial_RED: 1.0              # Initial red brightness
initial_GREEN: 0.0            # Initial green brightness
initial_BLUE: 0.0             # Initial blue brightness

[led serial_number]
white_pin: PA4
cycle_time: 0.010
hardware_pwm: False
initial_WHITE: 0.5

####################################################################################
#                                Z Tilt Adjustment
####################################################################################

[z_tilt]
#  z_positions: Location of toolhead
z_positions:               # Use Z_TILT_ADJUST to level the bed.
  -50, 18
  150, 348
  350, 18
points:
  #50, 50
  50, 100
  
  150, 250
  
  #250, 50
  250, 100
  
speed: 400                 # Speed of Z tilt adjustment
horizontal_move_z: 10      # Z axis position before horizontal move
retries: 3                 # Number of retries for adjustment points
retry_tolerance: 0.03      # Retry tolerance for adjustment accuracy

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 57
#*# pid_ki = 2
#*# pid_kd = 500
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.050758, -0.010039, 0.006074, -0.001631, 0.016713, 0.023778, 0.021987, -0.006203, 0.000863, 0.000667
#*# 	-0.021976, -0.003425, 0.009741, 0.019710, 0.020903, 0.020964, 0.009353, -0.007325, 0.007416, -0.013462
#*# 	-0.021732, -0.008421, 0.003934, 0.013294, 0.015491, 0.006277, 0.003336, -0.002578, -0.019127, -0.031209
#*# 	-0.033244, -0.015676, -0.006210, 0.006253, 0.008780, 0.000326, -0.008244, -0.024061, -0.039618, -0.059510
#*# 	-0.047864, -0.028693, -0.019368, -0.006374, 0.001602, -0.015367, -0.036682, -0.040137, -0.051100, -0.079478
#*# 	-0.060922, -0.033972, -0.022956, -0.015719, -0.016741, -0.033838, -0.052640, -0.066424, -0.078315, -0.101156
#*# 	-0.056114, -0.036547, -0.026047, -0.024324, -0.031332, -0.049613, -0.066428, -0.079116, -0.092648, -0.121065
#*# 	-0.046488, -0.030235, -0.024896, -0.024728, -0.030630, -0.049945, -0.066601, -0.087511, -0.106946, -0.135594
#*# 	-0.019394, -0.002216, -0.003392, -0.007688, -0.024910, -0.048246, -0.067732, -0.091537, -0.115829, -0.141497
#*# 	-0.012701, 0.001203, 0.003919, 0.012986, -0.000980, -0.036849, -0.061681, -0.087349, -0.110017, -0.139766
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 45.0
#*# max_x = 255.0
#*# min_y = 25.0
#*# max_y = 280.0
#*#
#*# [input_shaper]
#*# shaper_type_y = mzv
#*# shaper_freq_y = 81.4
#*# shaper_type_x = 2hump_ei
#*# shaper_freq_x = 112.6
#*#
#*# [tool_probe_endstop]
#*# z_offset = 10.781
